import React, { useState, useEffect, useCallback } from 'react';
import FileTree from '../components/FileTree';
import ContentPanel from '../components/ContentPanel';
import { FileItem } from '../types/FileTypes';
import { loadMarkdownFile } from '../utils/markdownLoader';

const Index = () => {
  const [selectedFile, setSelectedFile] = useState<FileItem | null>(null);
  const [focusedIndex, setFocusedIndex] = useState<number>(0);
  const [flatFileList, setFlatFileList] = useState<FileItem[]>([]);
  const [expandedFolders, setExpandedFolders] = useState<Set<string>>(new Set(['C:\\RESUME']));

  // –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–æ–≤–æ–≥–æ –¥–µ—Ä–µ–≤–∞
  const fileStructure: FileItem = {
    name: 'C:\\RESUME',
    type: 'folder',
    isExpanded: true,
    children: [
      {
        name: 'readme.txt',
        type: 'file',
        content: {
          title: 'README.TXT',
          subtitle: '–ë–∏–æ–≥—Ä–∞—Ñ–∏—è',
          items: [
            'IMG:/placeholder.svg|–§–æ—Ç–æ –°–µ—Ä–≥–µ—è –°–∏–Ω—è–∫–æ–≤–∞',
            '',
            '–°–µ—Ä–≥–µ–π –°–∏–Ω—è–∫–æ–≤ ‚Äî Product Owner / Product Manager.',
            '5+ –ª–µ—Ç –≤ IT, –∑–∞–ø—É—Å–∫ 3+ –ø—Ä–æ–¥—É–∫—Ç–æ–≤, —Ä–æ—Å—Ç MAU –Ω–∞ 150%.',
            '–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ 5+ –∫–æ–º–∞–Ω–¥–∞–º–∏ (7‚Äì12 —á–µ–ª–æ–≤–µ–∫), Agile/Scrum, SAFe.',
            '',
            '–§–æ–∫—É—Å:',
            '  ‚Ä¢ –ü—Ä–æ–¥—É–∫—Ç–æ–≤–∞—è —Å—Ç—Ä–∞—Ç–µ–≥–∏—è –∏ –º–µ—Ç—Ä–∏–∫–∏',
            '  ‚Ä¢ API‚Äëfirst, Secure by Design',
            '  ‚Ä¢ –ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ –ø—Ä–∏–æ—Ä–∏—Ç–∏–∑–∞—Ü–∏—è',
            '',
            '–ö–æ–Ω—Ç–∞–∫—Ç—ã:',
            '  ‚Ä¢ Email: sergey@pm-hero.com',
            '  ‚Ä¢ Telegram: @sergey_sinyakov',
            '  ‚Ä¢ LinkedIn: linkedin.com/in/sergey-sinyakov'
          ]
        }
      },
      {
        name: 'experience',
        type: 'folder',
        isExpanded: false,
        children: [
          {
            name: 'positive.log',
            type: 'file',
            content: {
              title: 'POSITIVE TECHNOLOGIES',
              subtitle: 'Product Owner (2023 - –Ω–∞—Å—Ç–æ—è—â–µ–µ –≤—Ä–µ–º—è)',
              items: [] // –ë—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–æ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ
            }
          },
          {
            name: 'ingosstrah.log',
            type: 'file',
            content: {
              title: '–ò–ù–ì–û–°–°–¢–†–ê–•',
              subtitle: 'Senior Product Manager (2021-2023)',
              items: [] // –ë—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–æ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ
            }
          },
          {
            name: 'antraks.log',
            type: 'file',
            content: {
              title: '–ê–ù–¢–†–ê–ö–° –ì–†–£–ü–ü',
              subtitle: 'Product Manager (2019-2021)',
              items: [] // –ë—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–æ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ
            }
          }
        ]
      },
      {
        name: 'skills.txt',
        type: 'file',
        content: {
          title: 'SKILLS.TXT',
          subtitle: '–ù–∞–≤—ã–∫–∏ –∏ –∫–æ–º–ø–µ—Ç–µ–Ω—Ü–∏–∏',
          items: [
            '‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó',
            '‚ïë               –ü–†–û–î–£–ö–¢–û–í–´–ï –ù–ê–í–´–ö–ò             ‚ïë',
            '‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£',
            '‚ïë [‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà] Roadmapping   95% ‚ïë',
            '‚ïë [‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà  ] Prioritization 90% ‚ïë',
            '‚ïë [‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà ] User Research  92% ‚ïë',
            '‚ïë [‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà   ] A/B Testing    85% ‚ïë',
            '‚ïë                                              ‚ïë',
            '‚ïë               –ú–ï–¢–û–î–û–õ–û–ì–ò–ò                    ‚ïë',
            '‚ïë [‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà  ] Agile/Scrum     88% ‚ïë',
            '‚ïë [‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà     ] SAFe Framework  75% ‚ïë',
            '‚ïë [‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà   ] Lean Startup    83% ‚ïë',
            '‚ïë [‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà    ] Design Thinking 80% ‚ïë',
            '‚ïë                                              ‚ïë',
            '‚ïë               –ê–ù–ê–õ–ò–¢–ò–ö–ê                      ‚ïë',
            '‚ïë [‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà   ] SQL             85% ‚ïë',
            '‚ïë [‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà ] Excel/Sheets     93% ‚ïë',
            '‚ïë [‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà    ] Python Basics   78% ‚ïë',
            '‚ïë [‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà   ] GA/Mixpanel     87% ‚ïë',
            '‚ïë                                              ‚ïë',
            '‚ïë               SOFT SKILLS                    ‚ïë',
            '‚ïë [‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà  ] –õ–∏–¥–µ—Ä—Å—Ç–≤–æ       91% ‚ïë',
            '‚ïë [‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà   ] –ö–æ–º–º—É–Ω–∏–∫–∞—Ü–∏—è    89% ‚ïë',
            '‚ïë [‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà] –ü—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–∏     96% ‚ïë',
            '‚ïë [‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà ] Problem Solving 94% ‚ïë',
            '‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù'
          ]
        }
      },
      {
        name: 'achievements.txt',
        type: 'file',
        content: {
          title: 'ACHIEVEMENTS.TXT',
          subtitle: '–î–æ—Å—Ç–∏–∂–µ–Ω–∏—è –∏ –Ω–∞–≥—Ä–∞–¥—ã',
          items: [
            '‚îå‚îÄ –¢–ò–¢–£–õ–´ –ò –ó–í–ê–ù–ò–Ø ‚îÄ‚îê',
            '‚îÇ                                                  ‚îÇ',
            '‚îÇ  üèÜ –ü–û–í–ï–õ–ò–¢–ï–õ–¨ MVP                              ‚îÇ',
            '‚îÇ     –ó–∞–ø—É—Å—Ç–∏–ª 8+ MVP –ø—Ä–æ–¥—É–∫—Ç–æ–≤                   ‚îÇ',
            '‚îÇ     –í—Ä–µ–º—è –æ—Ç –∏–¥–µ–∏ –¥–æ —Ä–µ–ª–∏–∑–∞: 2-6 –Ω–µ–¥–µ–ª—å         ‚îÇ',
            '‚îÇ                                                  ‚îÇ',
            '‚îÇ  ‚ö° –°–ü–ê–°–ò–¢–ï–õ–¨ –î–ï–î–õ–ê–ô–ù–û–í                         ‚îÇ',
            '‚îÇ     0 —Å–æ—Ä–≤–∞–Ω–Ω—ã—Ö —Ä–µ–ª–∏–∑–æ–≤ –∑–∞ 3 –≥–æ–¥–∞               ‚îÇ',
            '‚îÇ     –°—Ä–µ–¥–Ω—è—è —Ç–æ—á–Ω–æ—Å—Ç—å –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è: 94%          ‚îÇ',
            '‚îÇ                                                  ‚îÇ',
            '‚îÇ  üìä –ú–ê–ì –ú–ï–¢–†–ò–ö                                  ‚îÇ',
            '‚îÇ     –ü–æ—Å—Ç—Ä–æ–∏–ª —Å–∏—Å—Ç–µ–º—ã –º–µ—Ç—Ä–∏–∫ –≤ 4 –∫–æ–º–ø–∞–Ω–∏—è—Ö       ‚îÇ',
            '‚îÇ     –í–Ω–µ–¥—Ä–∏–ª data-driven –∫—É–ª—å—Ç—É—Ä—É               ‚îÇ',
            '‚îÇ                                                  ‚îÇ',
            '‚îÇ  üë®‚Äçüíº –õ–ò–î–ï–† –ö–û–ú–ê–ù–î                              ‚îÇ',
            '‚îÇ     –£–ø—Ä–∞–≤–ª—è–ª –∫–æ–º–∞–Ω–¥–∞–º–∏ –¥–æ 15 —á–µ–ª–æ–≤–µ–∫            ‚îÇ',
            '‚îÇ     Employee satisfaction: 4.8/5.0              ‚îÇ',
            '‚îÇ                                                  ‚îÇ',
            '‚îú‚îÄ –ö–õ–Æ–ß–ï–í–´–ï –î–û–°–¢–ò–ñ–ï–ù–ò–Ø ‚îÄ‚î§',
            '‚îÇ                                                  ‚îÇ',
            '‚îÇ  ‚Ä¢ –†–æ—Å—Ç –≤—ã—Ä—É—á–∫–∏ –Ω–∞ $5M+ (—Å—É–º–º–∞—Ä–Ω–æ)             ‚îÇ',
            '‚îÇ  ‚Ä¢ –ü—Ä–∏–≤–ª–µ—á–µ–Ω–∏–µ $2M –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–π                   ‚îÇ',
            '‚îÇ  ‚Ä¢ 150K+ –¥–æ–≤–æ–ª—å–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π                ‚îÇ',
            '‚îÇ  ‚Ä¢ 25+ –∑–∞–ø—É—â–µ–Ω–Ω—ã—Ö —Ñ–∏—á                          ‚îÇ',
            '‚îÇ  ‚Ä¢ 3 –Ω–∞–≥—Ä–∞–¥—ã "–õ—É—á—à–∏–π –ø—Ä–æ–¥—É–∫—Ç –≥–æ–¥–∞"             ‚îÇ',
            '‚îÇ                                                  ‚îÇ',
            '‚îú‚îÄ –°–ï–†–¢–ò–§–ò–ö–ê–¶–ò–ò ‚îÄ‚î§',
            '‚îÇ                                                  ‚îÇ',
            '‚îÇ  ‚úì Certified Scrum Product Owner (CSPO)        ‚îÇ',
            '‚îÇ  ‚úì SAFe Product Owner/Product Manager           ‚îÇ',
            '‚îÇ  ‚úì Google Analytics Individual Qualification    ‚îÇ',
            '‚îÇ  ‚úì Lean Six Sigma Green Belt                   ‚îÇ',
            '‚îÇ                                                  ‚îÇ',
            '‚îî‚îÄ –°–¢–ê–¢–ò–°–¢–ò–ö–ê ‚îÄ‚îò',
            '    –ü—Ä–æ–µ–∫—Ç–æ–≤ –∑–∞–≤–µ—Ä—à–µ–Ω–æ: 47',
            '    –ö–æ–º–∞–Ω–¥ –ø–æ–¥ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ–º: 12',
            '    –°—Ç—Ä–∞–Ω —Ä–∞–±–æ—Ç—ã: 3 (RU, BY, KZ)',
            '    –Ø–∑—ã–∫–∏: —Ä—É—Å—Å–∫–∏–π, –∞–Ω–≥–ª–∏–π—Å–∫–∏–π (B2)'
          ]
        }
      },
      {
        name: 'contacts',
        type: 'folder',
        isExpanded: false,
        children: [
          {
            name: 'email.vcf',
            type: 'file',
            content: {
              title: 'CONTACT.VCF',
              subtitle: '–ö–æ–Ω—Ç–∞–∫—Ç–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è',
              items: [
                'BEGIN:VCARD',
                'VERSION:3.0',
                'FN:–°–µ—Ä–≥–µ–π –°–∏–Ω—è–∫–æ–≤',
                'TITLE:Product Owner / Product Manager',
                'ORG:Positive Technologies',
                '',
                '‚îå‚îÄ –û–°–ù–û–í–ù–´–ï –ö–û–ù–¢–ê–ö–¢–´ ‚îÄ‚îê',
                '‚îÇ                                                  ‚îÇ',
                '‚îÇ  üìß Email: sergey@pm-hero.com                   ‚îÇ',
                '‚îÇ  üì± Telegram: @sergey_sinyakov                  ‚îÇ',
                '‚îÇ  üíº LinkedIn: linkedin.com/in/sergey-sinyakov   ‚îÇ',
                '‚îÇ  üêô GitHub: github.com/sergey-pm                ‚îÇ',
                '‚îÇ                                                  ‚îÇ',
                '‚îú‚îÄ –°–û–¶–ò–ê–õ–¨–ù–´–ï –°–ï–¢–ò ‚îÄ‚î§',
                '‚îÇ                                                  ‚îÇ',
                '‚îÇ  üê¶ Twitter: @pm_sergey                         ‚îÇ',
                '‚îÇ  üìö Habr: habr.com/users/sergey_pm              ‚îÇ',
                '‚îÇ  üé• YouTube: PM School by Sergey                ‚îÇ',
                '‚îÇ                                                  ‚îÇ',
                '‚îú‚îÄ –õ–û–ö–ê–¶–ò–Ø ‚îÄ‚î§',
                '‚îÇ                                                  ‚îÇ',
                '‚îÇ  üåç –ú–æ—Å–∫–≤–∞, –†–æ—Å—Å–∏—è                             ‚îÇ',
                '‚îÇ  üïê GMT+3 (Moscow Time)                         ‚îÇ',
                '‚îÇ  ‚úàÔ∏è  –ì–æ—Ç–æ–≤ –∫ —Ä–µ–ª–æ–∫–∞—Ü–∏–∏                          ‚îÇ',
                '‚îÇ                                                  ‚îÇ',
                '‚îú‚îÄ –ü–†–ï–î–ü–û–ß–¢–ï–ù–ò–Ø ‚îÄ‚î§',
                '‚îÇ                                                  ‚îÇ',
                '‚îÇ  üìû –õ—É—á—à–µ–µ –≤—Ä–µ–º—è –¥–ª—è –∑–≤–æ–Ω–∫–∞: 10:00-18:00        ‚îÇ',
                '‚îÇ  üí¨ –ü—Ä–µ–¥–ø–æ—á–∏—Ç–∞—é: Telegram, Email               ‚îÇ',
                '‚îÇ  üéØ –ò–Ω—Ç–µ—Ä–µ—Å—ã: Product, Startups, AI/ML          ‚îÇ',
                '‚îÇ                                                  ‚îÇ',
                '‚îî‚îÄ AVAILABILITY ‚îÄ‚îò',
                '    Status: Open to opportunities',
                '    Response time: < 24 hours',
                '    Languages: RU (native), EN (B2)',
                '',
                'END:VCARD'
              ]
            }
          }
        ]
      }
    ]
  };

  // –°–æ–∑–¥–∞—ë–º –ø–ª–æ—Å–∫–∏–π —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö —Ñ–∞–π–ª–æ–≤ –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
  const createFlatFileList = useCallback((item: FileItem, list: FileItem[] = [], expandedSet: Set<string>): FileItem[] => {
    list.push(item);
    if (item.type === 'folder' && expandedSet.has(item.name) && item.children) {
      item.children.forEach(child => createFlatFileList(child, list, expandedSet));
    }
    return list;
  }, []);

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –∏–∑ md —Ñ–∞–π–ª–æ–≤
  const loadFileContent = useCallback(async (file: FileItem) => {
    if (file.type === 'file' && file.name.endsWith('.log') && file.content) {
      const fileName = file.name.replace('.log', '');
      try {
        const items = await loadMarkdownFile(`/experience/${fileName}.md`);
        // –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç —Ñ–∞–π–ª–∞
        file.content.items = items;
      } catch (error) {
        console.error('Error loading markdown:', error);
        file.content.items = ['–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞'];
      }
    }
  }, []);

  // –û–±–Ω–æ–≤–ª—è–µ–º –ø–ª–æ—Å–∫–∏–π —Å–ø–∏—Å–æ–∫ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—ã—Ö –ø–∞–ø–æ–∫
  const updateFlatFileList = useCallback(() => {
    const flatList = createFlatFileList(fileStructure, [], expandedFolders);
    setFlatFileList(flatList);
    console.log('Updated flat file list:', flatList.map(f => f.name));
  }, [fileStructure, createFlatFileList, expandedFolders]);

  useEffect(() => {
    updateFlatFileList();
    
    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º readme.txt –∫–∞–∫ —Ñ–∞–π–ª –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    const readmeFile = fileStructure.children?.find(item => item.name === 'readme.txt');
    if (readmeFile && !selectedFile) {
      setSelectedFile(readmeFile);
      // –ù–∞–π–¥–µ–º –∏–Ω–¥–µ–∫—Å readme –≤ –æ–±–Ω–æ–≤–ª–µ–Ω–Ω–æ–º —Å–ø–∏—Å–∫–µ
      setTimeout(() => {
        const flatList = createFlatFileList(fileStructure, [], expandedFolders);
        const readmeIndex = flatList.findIndex(item => item.name === 'readme.txt' && item.type === 'file');
        if (readmeIndex !== -1) {
          setFocusedIndex(readmeIndex);
        }
      }, 0);
    }
  }, [expandedFolders, fileStructure, createFlatFileList, selectedFile, updateFlatFileList]);

  // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—ã—Ö –ø–∞–ø–æ–∫
  const handleExpandedChange = useCallback((newExpanded: Set<string>) => {
    setExpandedFolders(newExpanded);
  }, []);

  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–∞ —Å –∑–∞–≥—Ä—É–∑–∫–æ–π md –∫–æ–Ω—Ç–µ–Ω—Ç–∞
  const handleFileSelect = useCallback(async (file: FileItem) => {
    await loadFileContent(file);
    setSelectedFile(file);
  }, [loadFileContent]);

  // –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ —Å –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã
  useEffect(() => {
    const handleKeyDown = (event: KeyboardEvent) => {
      console.log('Key pressed:', event.key, 'Current focus:', focusedIndex, 'File list length:', flatFileList.length);
      
      switch (event.key) {
        case 'ArrowUp':
          event.preventDefault();
          setFocusedIndex(prev => {
            const newIndex = Math.max(0, prev - 1);
            console.log('Moving up from', prev, 'to', newIndex);
            return newIndex;
          });
          break;
        case 'ArrowDown':
          event.preventDefault();
          setFocusedIndex(prev => {
            const newIndex = Math.min(flatFileList.length - 1, prev + 1);
            console.log('Moving down from', prev, 'to', newIndex);
            return newIndex;
          });
          break;
        case 'Enter':
          event.preventDefault();
          const focusedFile = flatFileList[focusedIndex];
          console.log('Enter pressed on:', focusedFile);
          if (focusedFile) {
            if (focusedFile.type === 'file') {
              handleFileSelect(focusedFile);
            } else if (focusedFile.type === 'folder') {
              // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–∞–ø–∫–∏
              const newExpanded = new Set(expandedFolders);
              if (newExpanded.has(focusedFile.name)) {
                newExpanded.delete(focusedFile.name);
              } else {
                newExpanded.add(focusedFile.name);
              }
              console.log('Toggling folder:', focusedFile.name, 'New expanded:', newExpanded);
              setExpandedFolders(newExpanded);
              // –û–±–Ω–æ–≤–ª—è–µ–º –ø–ª–æ—Å–∫–∏–π —Å–ø–∏—Å–æ–∫ –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø–∞–ø–∫–∏
              setTimeout(() => {
                const newFlatList = createFlatFileList(fileStructure, [], newExpanded);
                setFlatFileList(newFlatList);
                console.log('Updated flat list after folder toggle:', newFlatList.map(f => f.name));
              }, 0);
            }
          }
          break;
        case 'Escape':
          event.preventDefault();
          setFocusedIndex(0);
          break;
      }
    };

    window.addEventListener('keydown', handleKeyDown);
    return () => window.removeEventListener('keydown', handleKeyDown);
  }, [flatFileList, focusedIndex, expandedFolders, fileStructure, createFlatFileList, handleFileSelect]);

  return (
    <div className="dos-interface">
      <div className="dos-header">
        <div className="dos-title">Norton Commander v2.0 - Resume Explorer</div>
        <div className="dos-time">{new Date().toLocaleString()}</div>
      </div>
      
      <div className="dos-panels">
        <FileTree 
          fileStructure={fileStructure} 
          onFileSelect={handleFileSelect}
          selectedFile={selectedFile}
          focusedIndex={focusedIndex}
          onFocusChange={setFocusedIndex}
          flatFileList={flatFileList}
          onExpandedChange={handleExpandedChange}
        />
        <ContentPanel selectedFile={selectedFile} />
      </div>
      
      <div className="dos-footer">
        <div className="dos-hotkeys">
          F1-Help F2-Rename F3-View F4-Edit F5-Copy F6-Move F7-MkDir F8-Delete F9-Menu F10-Quit | ‚Üë‚Üì-Navigate Enter-Select Esc-Reset
        </div>
      </div>
    </div>
  );
};

export default Index;
